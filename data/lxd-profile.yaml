# Copyright 2025 Vantage Compute Corporation
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

name: default
config:
  cloud-init.user-data: |
    #cloud-config
    package_update: true
    package_upgrade: true
    
    packages:
      # Essential build system and version control
      - git
      - build-essential
      - python3
      - unzip
      - gfortran
      
      # Core build tools (needed by Spack build process)
      - autoconf
      - automake
      - libtool
      - bison
      - flex
      - cmake
      - make
      - m4
      - pkg-config
      - ccache
      
      # System utilities (used by Spack/autotools)
      - findutils
      - diffutils
      - tar
      - gawk
      - gettext
      
      # Module system
      - lmod
      
    
    write_files:
      - path: /etc/profile.d/spack.sh
        permissions: '0644'
        owner: root:root
        content: |
          # Spack system-wide environment
          if [ -f /opt/spack/share/spack/setup-env.sh ]; then
            . /opt/spack/share/spack/setup-env.sh
          fi

    runcmd:
      # Install Spack v1.0.0 into /opt/spack (idempotent)
      - |
        bash -lc '
          set -euo pipefail
          if [ ! -d /opt/spack ]; then
            git clone --branch v1.0.0 https://github.com/spack/spack.git /opt/spack
            chown -R root:root /opt/spack
            chmod -R a+rX /opt/spack
          fi
        '
      - |
        for dir in /root/spack-project \
                   /srv/global-patches \
                   /opt/slurm-factory-cache/spack-buildcache \
                   /opt/slurm-factory-cache/spack-sourcecache \
                   /opt/slurm-factory-cache/builds; do
          mkdir -p "$dir"
        done
        chmod -R 777 /opt/slurm-factory-cache/* 2>/dev/null || true

devices:
  eth0:
    name: eth0
    nictype: bridged
    parent: lxdbr0
    type: nic
  root:
    path: /
    pool: default
    type: disk
  slurm-factory-cache:
    path: /opt/slurm-factory-cache
    source: CACHE_SOURCE_PLACEHOLDER
    shift: true
    type: disk
