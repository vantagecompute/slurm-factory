# Copyright 2025 Vantage Compute Corporation
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

name: "Build and Publish Slurm Dependencies for All Toolchains"

on:
  workflow_dispatch:
    inputs:
      toolchain_versions:
        description: 'Toolchain versions to use (comma-separated, e.g., "resolute,noble,rockylinux10" or "all")'
        required: true
        default: 'all'
        type: string
      use_slurm_buildcache:
        description: 'Use binary packages from slurm buildcache'
        required: false
        default: true
        type: boolean
      use_deps_buildcache:
        description: 'Use binary packages from deps buildcache'
        required: false
        default: true
        type: boolean

env:
  S3_BUCKET: slurm-factory-spack-buildcache-4b670
  CLOUDFRONT_URL: https://slurm-factory-spack-binary-cache.vantagecompute.ai

jobs:
  prepare-matrix:
    runs-on: self-hosted
    timeout-minutes: 3600
    outputs:
      toolchain_matrix: ${{ steps.set-matrix.outputs.toolchain_matrix }}
    steps:
      - name: Prepare version matrices
        timeout-minutes: 360
        id: set-matrix
        run: |
          # Prepare toolchain versions matrix
          if [ "${{ inputs.toolchain_versions }}" = "all" ]; then
            TOOLCHAINS='["resolute", "noble", "jammy", "rockylinux10", "rockylinux9", "rockylinux8"]'
          else
            IFS=',' read -ra VERS <<< "${{ inputs.toolchain_versions }}"
            TOOLCHAINS="["
            for v in "${VERS[@]}"; do
              v=$(echo "$v" | xargs)
              TOOLCHAINS="${TOOLCHAINS}\"${v}\","
            done
            TOOLCHAINS="${TOOLCHAINS%,}]"
          fi
          echo "toolchain_matrix=${TOOLCHAINS}" >> $GITHUB_OUTPUT
          echo "Building with toolchains: ${TOOLCHAINS}"

  build-and-publish-slurm-dependencies:
    needs: prepare-matrix
    runs-on: self-hosted
    timeout-minutes: 3600
    environment: release
    permissions:
      contents: read
      id-token: write
    
    strategy:
      fail-fast: false
      matrix:
        toolchain: ${{ fromJson(needs.prepare-matrix.outputs.toolchain_matrix) }}

    steps:
      - name: Checkout
        timeout-minutes: 360
        uses: actions/checkout@v5

      - name: "Set up Python"
        timeout-minutes: 360
        uses: actions/setup-python@v6
        with:
          python-version-file: ".python-version"

      - name: Install uv
        timeout-minutes: 360
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Clean previous builds
        timeout-minutes: 360
        run: |
          # Clean up any previous builds for this version/compiler combo
          docker images | grep "slurm-factory:25.11-${{ matrix.toolchain }}" | awk '{print $3}' | xargs -r docker rmi -f || true
          
          # Clean Spack cache directories to prevent state leakage between runs
          # This ensures the buildcache test truly validates buildcache installation
          rm -rf "$HOME/.spack"

      - name: Configure AWS credentials
        timeout-minutes: 360
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: us-east-1
          role-duration-seconds: 10800  # 3 hours for long-running builds

      - name: Validate GPG secrets
        timeout-minutes: 360
        env:
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
          GPG_KEY_ID: ${{ secrets.GPG_KEY_ID }}
        run: |
          if [ -z "$GPG_PRIVATE_KEY" ]; then
            echo "Error: GPG_PRIVATE_KEY secret is not set"
            exit 1
          fi
          if [ -z "$GPG_KEY_ID" ]; then
            echo "Error: GPG_KEY_ID secret is not set"
            exit 1
          fi
          echo "âœ“ GPG secrets are configured"
          echo "  GPG_KEY_ID: $GPG_KEY_ID"

      - name: Build Slurm dependencies and publish to buildcache
        timeout-minutes: 360
        env:
          GPG_KEY_ID: ${{ secrets.GPG_KEY_ID }}
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
        run: |
          echo "ðŸ”¨ Building Slurm 25.11 dependencies with ${{ matrix.toolchain }}..."
          if [ -z "$GPG_KEY_ID" ]; then
            echo "Error: GPG_KEY_ID is not set. Signed packages are required for publishing."
            exit 1
          fi
          if [ -z "$GPG_PRIVATE_KEY" ]; then
            echo "Error: GPG_PRIVATE_KEY is not set. Signed packages are required for publishing."
            exit 1
          fi
          if [ -z "$GPG_PASSPHRASE" ]; then
            echo "Error: GPG_PASSPHRASE is not set. Signed packages are required for publishing."
            exit 1
          fi
          echo "Using GPG signing key: $GPG_KEY_ID"
          
          # Build flags array
          BUILD_FLAGS=(
            --slurm-version 25.11
            --toolchain ${{ matrix.toolchain }}
            --gpu
            --no-cache
            --publish=deps
            --signing-key "$GPG_KEY_ID"
            --gpg-private-key "$GPG_PRIVATE_KEY"
            --gpg-passphrase "$GPG_PASSPHRASE"
          )
          
          # Add buildcache flags based on inputs
          if [ "${{ inputs.use_deps_buildcache }}" = "false" ]; then
            BUILD_FLAGS+=(--no-use-deps-buildcache)
          fi
          if [ "${{ inputs.use_slurm_buildcache }}" = "false" ]; then
            BUILD_FLAGS+=(--no-use-slurm-buildcache)
          fi
          
          uv run slurm-factory build-slurm "${BUILD_FLAGS[@]}"

          # Cleanup build cache
          for i in `docker image list --format json | jq -r .ID`; do docker rmi $i -f; done
          docker buildx prune -f

      - name: Summary
        timeout-minutes: 360
        if: always()
        run: |
          echo "## Slurm Dependencies Buildcache Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Slurm Version:** 25.11" >> $GITHUB_STEP_SUMMARY
          echo "**Toolchain:** ${{ matrix.toolchain }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Buildcache Location:**" >> $GITHUB_STEP_SUMMARY
          echo "- S3: \`s3://${{ env.S3_BUCKET }}/${{ matrix.toolchain }}/slurm/deps/\`" >> $GITHUB_STEP_SUMMARY
          echo "- CloudFront: ${{ env.CLOUDFRONT_URL }}/${{ matrix.toolchain }}/slurm/deps/" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Note:** This buildcache contains only Slurm dependencies (excluding Slurm itself)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Usage:**" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "spack mirror add slurm-factory-deps-buildcache ${{ env.CLOUDFRONT_URL }}/${{ matrix.toolchain }}/slurm/deps" >> $GITHUB_STEP_SUMMARY
          echo "spack buildcache keys --install --trust" >> $GITHUB_STEP_SUMMARY
          echo "spack install <dependency>" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

  summary:
    needs: build-and-publish-slurm-dependencies
    runs-on: self-hosted
    timeout-minutes: 3600
    if: always()
    steps:
      - name: Build Summary
        timeout-minutes: 360
        run: |
          echo "## Overall Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All Slurm dependency buildcaches have been built and published." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Slurm Versions:** 25.11" >> $GITHUB_STEP_SUMMARY
          echo "**Toolchain Versions:** ${{ inputs.toolchain_versions }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**S3 Bucket:** \`s3://${{ env.S3_BUCKET }}/${{ inputs.toolchain_versions }}/slurm/deps/\`" >> $GITHUB_STEP_SUMMARY
          echo "**CloudFront URL:** ${{ env.CLOUDFRONT_URL }}/${{ inputs.toolchain_versions }}/slurm/deps/" >> $GITHUB_STEP_SUMMARY